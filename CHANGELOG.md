# Changelog - Расширенный админ-функционал

## Добавленные файлы

### 1. `utils/yaml_utils.py`
Утилиты для работы с YAML файлами:
- `sanitize_story_id()` - защита от path traversal
- `validate_story()` - валидация структуры истории
- `parse_yaml()` - парсинг YAML с обработкой ошибок
- `save_story()` - безопасное сохранение истории
- `load_story_file()` - загрузка истории из файла
- `story_exists()` - проверка существования истории
- `delete_story()` - удаление/перемещение истории
- `get_story_summary()` - краткая сводка по истории
- `format_story_yaml()` - форматирование в YAML строку

### 2. `admin/states.py`
FSM состояния для админ-команд (перенесены в `admin/editor.py`)

### 3. `admin/editor.py`
Расширенные админ-команды:
- `/admin` - главное меню
- `/admin_stories` - список историй
- `/admin_edit_text` - редактирование текста сцен (многострочный ввод)
- `/admin_choices` - список выборов
- `/admin_add_choice` - добавление выбора
- `/admin_delete_choice` - удаление выбора
- `/admin_upload` - загрузка истории (текст/файл)
- `/admin_export` - экспорт истории
- `/admin_delete` - удаление истории с подтверждением
- `/admin_reload` - перезагрузка историй
- `/admin_validate` - валидация истории
- `/admin_preview` - preview режим для тестирования

### 4. `ADMIN_GUIDE.md`
Полное руководство администратора с примерами использования всех команд

## Изменённые файлы

### 1. `engine/story_engine.py`
- Добавлен метод `reload_stories()` для перезагрузки историй
- Поддержка загрузки `.yml` файлов (в дополнение к `.yaml`)

### 2. `bot.py`
- Подключён роутер `admin_editor_router` для расширенных админ-команд

## Безопасность

- ✅ Защита от path traversal в `sanitize_story_id()`
- ✅ Валидация всех `story_id` перед использованием
- ✅ Ограничение размера текста (8000 символов)
- ✅ Проверка прав доступа для всех админ-команд
- ✅ Валидация YAML перед сохранением

## Функциональность

### Редактирование текста
- ✅ Однострочный ввод
- ✅ Многострочный ввод через команды "добавить строку" / "завершить"

### Управление выбором
- ✅ Список выборов
- ✅ Добавление выбора с выбором next_scene через inline-кнопки
- ✅ Удаление выбора
- ⚠️ Редактирование выбора (можно реализовать через удаление + добавление)

### Загрузка истории
- ✅ Загрузка текстом (YAML в сообщении)
- ✅ Загрузка файлом (.yaml/.yml)
- ✅ Подтверждение перезаписи существующих историй
- ✅ Автоматическая валидация после загрузки

### Экспорт истории
- ✅ Экспорт как текст (если помещается)
- ✅ Экспорт как файл (если слишком большой)

### Удаление истории
- ✅ Подтверждение через inline-кнопки
- ✅ Безопасное удаление (перемещение в `_deleted/`)

### Валидация
- ✅ Проверка обязательных полей
- ✅ Проверка ссылок на сцены/финалы
- ✅ Отделение ошибок от предупреждений

### Preview режим
- ✅ Запуск истории как для игрока
- ✅ Пометка preview в сообщениях

## Ограничения и известные проблемы

1. **Редактирование выбора**: Пока не реализовано полное редактирование (можно удалить и добавить заново)
2. **Условия и эффекты в выборе**: Добавление через конструктор пока упрощённое (можно добавить вручную в YAML)
3. **Preview режим**: Использует обычную таблицу `runs`, но помечается в сообщениях

## Миграции БД

Миграции не требуются - используются существующие таблицы.

## Тестирование

Рекомендуется протестировать:
1. Загрузку истории (текст и файл)
2. Редактирование текста (однострочный и многострочный режимы)
3. Добавление/удаление выборов
4. Валидацию существующих историй
5. Preview режим

## Документация

Полная документация доступна в `ADMIN_GUIDE.md`.
